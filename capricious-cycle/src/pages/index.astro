---
import { getCourses } from '../lib/notion.js';
import { supabase } from '../lib/supabase.js';

const courses = await getCourses();
const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
---

<!--
  📄 页面名称：首页
  📍 页面路径：/
  📦 所属模块：公共展示
  🎯 页面功能：
    - 展示课程入口
    - 测试 Supabase 用户连接状态
    - 提交和查询 xAPI 学习记录（用于测试用途）

  🎨 组件依赖：
    - 无（页面内直接渲染）

  🧩 页面意义：
    - 课程平台主入口，用户首次访问展示核心信息
    - 用于后续转化和功能入口跳转

  🧠 注意事项：
    - 当前页面以测试逻辑为主，后续可能替换为真正的首页内容（如 Hero、CTA、导航等）
-->

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>课程列表</title>
    <script type="module" is:inline>
      (async () => {
        // xAPI 测试代码
        const {
          submitXAPIStatement: submitStatement,
          fetchXAPIStatements: getStatements
        } = await import('/src/lib/api/xapi.client.ts');

        const testStatement = {
          actor: {
            name: 'test-user',
            mbox: 'mailto:test-user@example.com',
            objectType: 'Agent'
          },
          verb: {
            id: 'http://adlnet.gov/expapi/verbs/viewed',
            display: { 'en-US': 'viewed' }
          },
          object: {
            id: 'http://example.com/course_home',
            objectType: 'Activity',
            definition: {
              name: { 'en-US': 'Course Home' },
              description: { 'en-US': 'The course home page' }
            }
          },
          result: {
            score: { raw: 100 },
            success: true
          },
          timestamp: new Date().toISOString()
        };

        console.log('提交前内容', testStatement);

        if (!testStatement.actor || !testStatement.verb || !testStatement.object) {
          console.error('[xAPI] 语句缺少必要字段');
          return;
        }

        try {
          await submitStatement(testStatement);
          console.log('[xAPI] 提交成功');

          const res = await getStatements('test-user');
          console.log('[xAPI] 查询结果：', res);
        } catch (err) {
          console.error('[xAPI] 错误：', err);
        }
      })();
    </script>
  </head>
  <body>
    <div class="min-h-screen bg-gray-50 text-gray-800 p-8">
      <h1 class="text-3xl font-bold mb-6">课程列表</h1>
      <ul class="space-y-4">
        {courses.map((course) => (
          <li class="bg-white shadow rounded-lg p-4">
            <strong>{course.title}</strong><br />
            类别：{course.category}  |  价格：¥{course.price}
          </li>
        ))}
      </ul>
    </div>
    <div class="mt-10 p-4 bg-yellow-100 border border-yellow-300 rounded">
      <h2 class="font-semibold text-lg mb-2">[Supabase 连接测试]</h2>
      {sessionError ? (
        <p class="text-red-600">出错了：{sessionError.message}</p>
      ) : (
        <p class="text-green-700">当前用户：{sessionData.session?.user?.email ?? '未登录'}</p>
      )}
    </div>
  </body>
</html>

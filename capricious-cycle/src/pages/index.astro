---
import { getCourses } from '../lib/notion.js';
import { supabase } from '../lib/supabase.js';

const courses = await getCourses();
const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
---

<!--
  ğŸ“„ é¡µé¢åç§°ï¼šé¦–é¡µ
  ğŸ“ é¡µé¢è·¯å¾„ï¼š/
  ğŸ“¦ æ‰€å±æ¨¡å—ï¼šå…¬å…±å±•ç¤º
  ğŸ¯ é¡µé¢åŠŸèƒ½ï¼š
    - å±•ç¤ºè¯¾ç¨‹å…¥å£
    - æµ‹è¯• Supabase ç”¨æˆ·è¿æ¥çŠ¶æ€
    - æäº¤å’ŒæŸ¥è¯¢ xAPI å­¦ä¹ è®°å½•ï¼ˆç”¨äºæµ‹è¯•ç”¨é€”ï¼‰

  ğŸ¨ ç»„ä»¶ä¾èµ–ï¼š
    - æ— ï¼ˆé¡µé¢å†…ç›´æ¥æ¸²æŸ“ï¼‰

  ğŸ§© é¡µé¢æ„ä¹‰ï¼š
    - è¯¾ç¨‹å¹³å°ä¸»å…¥å£ï¼Œç”¨æˆ·é¦–æ¬¡è®¿é—®å±•ç¤ºæ ¸å¿ƒä¿¡æ¯
    - ç”¨äºåç»­è½¬åŒ–å’ŒåŠŸèƒ½å…¥å£è·³è½¬

  ğŸ§  æ³¨æ„äº‹é¡¹ï¼š
    - å½“å‰é¡µé¢ä»¥æµ‹è¯•é€»è¾‘ä¸ºä¸»ï¼Œåç»­å¯èƒ½æ›¿æ¢ä¸ºçœŸæ­£çš„é¦–é¡µå†…å®¹ï¼ˆå¦‚ Heroã€CTAã€å¯¼èˆªç­‰ï¼‰
-->

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>è¯¾ç¨‹åˆ—è¡¨</title>
    <script type="module" is:inline>
      (async () => {
        // xAPI æµ‹è¯•ä»£ç 
        const {
          submitXAPIStatement: submitStatement,
          fetchXAPIStatements: getStatements
        } = await import('/src/lib/api/xapi.client.ts');

        const testStatement = {
          actor: {
            name: 'test-user',
            mbox: 'mailto:test-user@example.com',
            objectType: 'Agent'
          },
          verb: {
            id: 'http://adlnet.gov/expapi/verbs/viewed',
            display: { 'en-US': 'viewed' }
          },
          object: {
            id: 'http://example.com/course_home',
            objectType: 'Activity',
            definition: {
              name: { 'en-US': 'Course Home' },
              description: { 'en-US': 'The course home page' }
            }
          },
          result: {
            score: { raw: 100 },
            success: true
          },
          timestamp: new Date().toISOString()
        };

        console.log('æäº¤å‰å†…å®¹', testStatement);

        if (!testStatement.actor || !testStatement.verb || !testStatement.object) {
          console.error('[xAPI] è¯­å¥ç¼ºå°‘å¿…è¦å­—æ®µ');
          return;
        }

        try {
          await submitStatement(testStatement);
          console.log('[xAPI] æäº¤æˆåŠŸ');

          const res = await getStatements('test-user');
          console.log('[xAPI] æŸ¥è¯¢ç»“æœï¼š', res);
        } catch (err) {
          console.error('[xAPI] é”™è¯¯ï¼š', err);
        }
      })();
    </script>
  </head>
  <body>
    <div class="min-h-screen bg-gray-50 text-gray-800 p-8">
      <h1 class="text-3xl font-bold mb-6">è¯¾ç¨‹åˆ—è¡¨</h1>
      <ul class="space-y-4">
        {courses.map((course) => (
          <li class="bg-white shadow rounded-lg p-4">
            <strong>{course.title}</strong><br />
            ç±»åˆ«ï¼š{course.category}  |  ä»·æ ¼ï¼šÂ¥{course.price}
          </li>
        ))}
      </ul>
    </div>
    <div class="mt-10 p-4 bg-yellow-100 border border-yellow-300 rounded">
      <h2 class="font-semibold text-lg mb-2">[Supabase è¿æ¥æµ‹è¯•]</h2>
      {sessionError ? (
        <p class="text-red-600">å‡ºé”™äº†ï¼š{sessionError.message}</p>
      ) : (
        <p class="text-green-700">å½“å‰ç”¨æˆ·ï¼š{sessionData.session?.user?.email ?? 'æœªç™»å½•'}</p>
      )}
    </div>
  </body>
</html>

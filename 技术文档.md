# ğŸ“Š xAPI æ•°æ®é“¾è·¯æ€»è§ˆï¼ˆå†™å…¥ + æŸ¥è¯¢ï¼‰

## âœ… æ•°æ®å†™å…¥é“¾è·¯ï¼ˆPOSTï¼‰

```text
[å‰ç«¯é¡µé¢æˆ–è„šæœ¬]
       â”‚
       â–¼
submitXAPIStatement(statement: XAPIStatement)  
       â† src/lib/api/xapi.client.ts
       â”‚
       â–¼
POST /api/statement.ts  
       â† src/pages/api/statement.ts
       â”‚
   [æ ¡éªŒ JSON è¯·æ±‚ä½“æ ¼å¼ï¼ˆactor / verb / objectï¼‰]
       â”‚
   [ç”Ÿæˆ UUID + timestamp]
       â”‚
   [è°ƒç”¨ env.LRS_DB.prepare(...).run()] 
       âŸ¶ æ’å…¥ D1 æ•°æ®åº“ï¼štibetan-lrs-db.statements è¡¨
       â”‚
       â–¼
å“åº”ï¼š{ status: "ok", id: "<uuid>" }
```

---

### ğŸ” æ•°æ®æŸ¥è¯¢é“¾è·¯ï¼ˆGETï¼‰

```text
[å‰ç«¯é¡µé¢æˆ–è„šæœ¬]
       â”‚
       â–¼
fetchXAPIStatements({actor?, session_id?})  
     â† src/lib/api/xapi.client.ts
       â”‚
       â–¼
GET /api/statement.ts?actor=...&session_id=...
       â† src/pages/api/statement.ts
       â”‚
   [æ‹¼æ¥æŸ¥è¯¢å‚æ•° â†’ SQL WHERE å­å¥]
       â”‚
   [è°ƒç”¨ env.LRS_DB.prepare(...).all()]  
       âŸ¶ æŸ¥è¯¢ D1 æ•°æ®åº“ï¼štibetan-lrs-db.statements è¡¨
       â”‚
       â–¼
å“åº”ï¼š{ statements: [...] }
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„ä¸èŒè´£è¯´æ˜

| æ–‡ä»¶è·¯å¾„ | ä½œç”¨æè¿° | è¯´æ˜ |
|----------|----------|------|
| `src/pages/api/statement.ts` | ğŸŒ **API æ¥å£ä¸»å…¥å£**ï¼šç»Ÿä¸€å¤„ç† xAPI å†™å…¥ä¸æŸ¥è¯¢ | æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æœåŠ¡å…¥å£ï¼Œç›´æ¥è¿æ¥æ•°æ®åº“ï¼Œä¸ä¾èµ–ä»»ä½•å¤–éƒ¨è·¯ç”±æœºåˆ¶ï¼ˆå¦‚ Honoï¼‰ |
| `src/lib/api/xapi.client.ts` | ğŸ§  å‰ç«¯è°ƒç”¨æ¡¥ | å°è£…å‰ç«¯è¯·æ±‚ `/api/statement` æ¥å£çš„æäº¤å’ŒæŸ¥è¯¢å‡½æ•°ï¼Œä¾› React/Vue/æ¨¡æ¿ç­‰ UI ç»„ä»¶è°ƒç”¨ |
| `src/types/env.d.ts` | ğŸ”§ å£°æ˜ç¯å¢ƒç»‘å®š | æŒ‡å®š `LRS_DB: D1Database` ç»‘å®šåç§°ï¼Œç¡®ä¿ Cloudflare Workers å¯è®¿é—®æ•°æ®åº“ |
| `migrations/001_init.sql` | ğŸ§± æ•°æ®ç»“æ„è¿ç§»è„šæœ¬ | åˆ›å»º `statements` è¡¨ï¼ŒåŒ…å«å­—æ®µå®šä¹‰å’Œçº¦æŸ |
| `wrangler.toml` | âš™ï¸ Cloudflare é…ç½®æ–‡ä»¶ | å£°æ˜ D1 æ•°æ®åº“ç»‘å®šï¼ˆLRS_DBï¼‰ã€KVã€R2 ç­‰ï¼Œæ˜ç¡®ç»‘å®š ID ä¸åç§° |
| ï¼ˆæœªæ¥æ¨èï¼‰`docs/xapi-schema.md` | ğŸ“š Schema ç»“æ„è¯´æ˜ | æ¨èå†™æ¸… actor/verb/object/result çš„ç»“æ„çº¦å®šï¼Œæå‡è§„èŒƒæ€§ä¸å¯ç»´æŠ¤æ€§ |

---

## ğŸ§® `statements` è¡¨ç»“æ„ï¼ˆD1 æ•°æ®åº“ï¼‰

```sql
CREATE TABLE IF NOT EXISTS statements (
  id TEXT PRIMARY KEY,              -- è‡ªåŠ¨ç”Ÿæˆçš„ UUID
  actor TEXT NOT NULL,              -- å¿…å¡«ï¼šå­¦ä¹ è€…æ ‡è¯†ï¼ˆé‚®ç®±/IDï¼‰
  verb TEXT NOT NULL,               -- å¿…å¡«ï¼šè¡Œä¸ºï¼ˆviewed/completed ç­‰ï¼‰
  object TEXT NOT NULL,             -- å¿…å¡«ï¼šå­¦ä¹ å¯¹è±¡ï¼ˆé¡µé¢/è¯¾ç¨‹ç­‰ IDï¼‰
  result JSON,                      -- å¯é€‰ï¼šå­¦ä¹ ç»“æœï¼Œä»»æ„ JSON ç»“æ„
  timestamp TEXT NOT NULL,          -- è‡ªåŠ¨ç”Ÿæˆæ—¶é—´æˆ³
  session_id TEXT                   -- å¯é€‰ï¼šå­¦ä¹ ä¼šè¯ ID
);
```

---

## ğŸ“¦ å‰ç«¯è°ƒç”¨æ–¹å¼

### 1. æäº¤è¯­å¥ï¼ˆå†™å…¥ï¼‰

```ts
import { submitXAPIStatement } from '@/lib/api/xapi.client';

await submitXAPIStatement({
  actor: 'user@example.com',
  verb: 'viewed',
  object: 'course:lesson-1',
  result: { score: 95 },
  session_id: 'abc-session-xyz',
});
```

è¿”å›å€¼ï¼š

```ts
{
  status: "ok",
  id: "6f782d53-fabd-44d7-8a2e-35d9b1e0b2de"
}
```

---

### 2. æŸ¥è¯¢è¯­å¥ï¼ˆæŒ‰ actor/session_idï¼‰

```ts
import { fetchXAPIStatements } from '@/lib/api/xapi.client';

const result = await fetchXAPIStatements({ actor: 'user@example.com' });

console.log(result.statements); // è¿”å›è¯­å¥æ•°ç»„
```

---

## âœ… æ€»ç»“

- âœ… æ‰€æœ‰æ•°æ®å†™å…¥ä¸æŸ¥è¯¢ï¼Œ**å‡é€šè¿‡ `/api/statement.ts` å®ç°**
- âœ… å½“å‰ç³»ç»Ÿæ— ä»»ä½• Hono è·¯ç”±æˆ–å…¶ä»–å¤šä½™å…¥å£ï¼Œ**æ•°æ®é“¾è·¯æ¸…æ™°ã€å•ä¸€ã€å¯ç»´æŠ¤**
- âœ… D1 æ•°æ®åº“ç»“æ„åˆç†ï¼Œæ”¯æŒåæœŸæ‰©å±• session/æ¨¡å—/ç”¨æˆ·ç­‰ç»´åº¦
- âœ… å‰ç«¯åªéœ€è°ƒç”¨ `xapi.client.ts` æä¾›çš„å‡½æ•°ï¼Œæ— éœ€å…³å¿ƒåº•å±‚ API ç»†èŠ‚

---

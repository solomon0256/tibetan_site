# 七大核心系统对应表

| 核心系统                        | 下属小板块                         | 技术路线实现方式                                         | 可行性 | 备注                                           |
| ------------------------------- | ---------------------------------- | -------------------------------------------------------- | ------ | ---------------------------------------------- |
| **1. 内容管理系统（CMS 同步层）** | Notion 同步服务                    | Cloudflare Scheduled Worker 每 5min 轮询 Notion updated_time 差分 | ✅     | 替代 Webhook 实现                              |
|                                 | 同步 Worker                        | `src/workers/notion-sync.ts` 定时调用 Proxy               | ✅     | 执行清洗差分，写入 KV                           |
|                                 | 数据清洗与映射                     | 同步 Worker 内部逻辑                                      | ✅     | 字段映射与类型转换                             |
|                                 | 构建时拉取 API                     | `src/lib/notion.js` 中 `getCourses()`                     | ✅     | 构建阶段动态拉取，无需额外脚本                  |
|                                 | 课程元数据表                       | Worker 写入 D1 `course_metadata` 表                       | ✅     | Phase-1 将迁移至 Supabase，但 D1 临时可用       |
|                                 | 文本/多媒体资源索引               | 同步 Worker 写入 KV `course:media:<id>`                  | ✅     | 媒体列表 JSON 存 KV                            |
|                                 | 媒体文件存储（R2）                | 同步 Worker 或脚本上传至 R2 `course/{id}/media`          | ✅     | 公开读权限                                    |
|                                 | 运行时内容查询 API                 | Worker `/api/content/:slug` 读取 KV/R2                   | ✅     | 增加 SSR 式查询                                |
|                                 | 缓存/失效策略                     | Cloudflare Pages + KV + HTTP Cache-Control               | ✅     | KV TTL 与 Cache-Control 保证最新性              |
| **2. 前端 UI 系统**             | 页面框架                           | Astro + Tailwind + `src/layouts/Layout.astro` + 文件路由  | ✅     |                                                |
|                                 | 组件库                             | shadcn/ui + 自定义 Tailwind 组件                         | ✅     |                                                |
|                                 | 本地状态管理                       | React Hooks                                              | ✅     |                                                |
|                                 | 全局状态管理                       | React Context                                            | ✅     |                                                |
|                                 | 国际化 (i18n)                     | 无                                                       | ❌     | MVP 阶段尚未配置                               |
|                                 | 可访问性 (a11y)                   | 手动审核 + Lighthouse                                     | 🟡     | 待集成 CI lint/插件                           |
|                                 | 响应式设计 (Mobile/PC)            | Tailwind 响应式工具类                                    | ✅     |                                                |
| **3. 后端 API 系统**            | 认证授权 API                       | Supabase Auth + 自建中间件（待构建）                      | 🟡     | Phase-1 完成                                 |
|                                 | 内容服务 API                       | Cloudflare Worker `/api/courses` 等                      | ✅     |                                                |
|                                 | 学习进度 API                       | Cloudflare Worker `/api/statement` + `/api/progress`     | ✅     |                                                |
|                                 | 支付回调 API                       | Stripe Webhook Worker                                    | ✅     |                                                |
|                                 | 管理后台 API                       | Phase-1: Directus / Next.js Admin                        | 🟡     | 后续迭代                                    |
| **4. 数据存储系统**             | 主业务数据库 (D1/Postgres)        | Cloudflare D1 (临时) → Supabase Postgres Phase-1         | ✅     | D1 临时承载小表，迁移后使用 Postgres            |
|                                 | 进度存储 (Cloudflare D1)          | D1 表 `statements`                                       | ✅     |                                                |
|                                 | 静态资源 (R2)                     | R2 Buckets                                              | ✅     |                                                |
|                                 | 缓存层 (KV)                       | Cloudflare KV                                            | ✅     |                                                |
| **5. 安全认证系统**             | 密码哈希 / OAuth                  | Supabase Auth 客户端初始化                               | 🟡     | 无后端路由实现                                  |
|                                 | JWT 管理                           | Supabase 客户端 Token 管理                               | 🟡     | 缺少服务器端刷新接口                             |
|                                 | ACL/RBAC                           | Phase-1: Postgres RLS                                     | 🟡     | 后续迭代                                    |
|                                 | CSRF/XSS 防御                     | CSP + Astro sanitize + CI                                 | ✅     |                                                |
| **6. 支付变现系统**             | 订单创建                           | Stripe Payment Link                                      | ✅     |                                                |
|                                 | 支付流程                           | Stripe Payment Link 重定向                               | ✅     |                                                |
|                                 | Webhook 处理                       | Stripe Webhook Worker                                    | ✅     |                                                |
|                                 | 对账与通知                         | Cloudflare Logpush + Slack                                | ✅     |                                                |
| **7. 监控与运维系统**           | 日志收集                           | Sentry + Logflare                                        | ✅     |                                                |
|                                 | 性能监控                           | Cloudflare Analytics                                     | ✅     |                                                |
|                                 | 告警与通知                         | Cloudflare Logpush + Workers KV → Slack Webhook          | ✅     |                                                |
|                                 | CI/CD 流程                        | GitHub Actions + Playwright                              | ✅     |                                                |
|                                 | 自动化恢复脚本                     | GitHub Actions 定时触发 R2/D1 备份                        | ✅     |                                                |
|                                 | 滚动发布/回滚                     | Cloudflare Pages Atomic Deploy + Rollback Script         | ✅     |                                                |

> **无法实现或暂缓**：  
>
> - H5P 相关功能在 MVP-0 中保留 CLI 支持（B-11），但因资源优先级暂缓使用。  
> - 管理后台 API（部分高级权限管理）与 ACL/RBAC 细节将在 Phase-1（G-3/G-4）及后续迭代中完善。

---

以下为基于 MVP-0∼MVP-1 阶段现有技术栈的现实可行性核对表：

**状态含义**

- ✅ 已实现：已有代码或脚本覆盖；部署后即可工作
- 🟡 暂缓实现：官方计划到 Phase-1/后续里程碑再做
- ❌ 目前无法实现：仅凭 MVP 现有组件无法落地，需引入额外服务或改动技术栈

| 核心系统 → 小板块               | MVP 实现状态 | MVP 现有 / 计划实现方式                           | 备注                                     |
| ------------------------------ | ------------ | ------------------------------------------------ | --------------------------------------- |
| Notion Webhook 触发             | ❌           | 无                                               | Notion API 无推送；使用 Proxy 进行转发     |
| 同步 Worker                     | ✅           | `src/workers/notion-sync.ts` 定时轮询 Proxy      | 执行清洗差分，写入 KV                    |
| 数据清洗与映射                  | ✅           | 同步 Worker 内部逻辑                             | 字段映射与类型转换                      |
| 构建时拉取 API                  | ✅           | `src/lib/notion.js` 中 `getCourses()`            | 构建阶段动态拉取，无需额外脚本             |
| 课程元数据表                    | ✅           | Worker 写入 D1 `course_metadata` 表              | Phase-1 将迁移至 Supabase，但 D1 临时可用  |
| 文本/多媒体资源索引             | ✅           | 同步 Worker 写入 KV `course:media:<id>`          | 媒体列表 JSON 存 KV                     |
| 媒体文件存储（R2）              | ✅           | 同步 Worker 或脚本上传至 R2 `course/{id}/media`  | 公开读权限                             |
| 运行时内容查询 API              | ✅           | Worker `/api/content/:slug` 读取 KV/R2           | 增加 SSR 式查询                          |
| 缓存/失效策略                   | ✅           | Cloudflare Pages + KV + HTTP Cache-Control       | KV TTL 与 Cache-Control 保证最新性       |
| 页面框架                        | ✅           | Astro + Tailwind + src/layouts/Layout.astro + 文件路由 |                                         |
| 组件库                          | ✅           | shadcn/ui + 自定义 Tailwind 组件                 |                                         |
| 本地状态管理                    | ✅           | React Hooks                                      |                                         |
| 全局状态管理                    | ✅           | React Context                                    |                                         |
| 国际化 (i18n)                   | ❌           | 无                                               | MVP 阶段尚未配置                          |
| 可访问性 (a11y)                 | 🟡           | 手动审核 + Lighthouse                            | 待集成 CI lint/插件                      |
| 响应式设计 (Mobile/PC)          | ✅           | Tailwind 响应式工具类                            |                                         |
| 内容服务 API                    | ✅           | Cloudflare Worker `/api/courses` 等              | 课程列表/详情及筛选已实现                 |
| 学习进度 API                    | ✅           | Worker `/api/statement` + `/api/progress`        | xAPI 存储与进度查询功能                   |
| 注册/登录接口                   | 🟡           | 计划 Supabase Auth（Phase-1）                    | MVP 仅软门禁，无真正账号体系              |
| Token 刷新/黑名单               | ❌           | 无                                               | 依赖 Supabase/自建中间件                  |
| 权限校验中间件                  | ❌           | 无                                               | ACL/RBAC 需 Postgres RLS；Phase-1         |
| 课程列表/详情 API               | ✅           | Astro 预渲染 JSON                                | —                                       |
| 旅游/文化 API                   | ✅           | 同上                                            | —                                       |
| 搜索/筛选 API                   | ❌           | 无                                               | 需 Algolia/ES；未纳入 MVP                 |
| xAPI 语句写入                   | ✅           | Worker → D1 JSON                                 | 本地 JSON 合并冲突风险高                  |
| 进度汇总查询                    | ❌           | 无                                               | 需 Supabase 聚合或 Edge Function          |
| Stripe Webhook 处理             | 🟡           | Worker -> KV -> D1                               | 仅支付成功；退款/失效未处理               |
| 管理后台 CRUD                   | ❌           | 无                                               | 下一步 Directus                          |
| 报表/统计接口                   | ❌           | 无                                               | 依赖 Supabase 或 BI                      |
| Postgres 主业务库               | ❌           | 无                                               | Supabase Pro 随 Phase-1 引入              |
| xAPI 语句表 (D1)                | ✅           | D1 statements                                    | 容量 10 GB 限制                          |
| 汇总表 user_progress            | ❌           | 无                                               | 需 Phase-1 入 PG                         |
| 静态资源 R2                     | ✅           | 目录 course/ID                                   | —                                       |
| 缓存 KV                         | ✅           | 热点 JSON 缓存                                   | —                                       |
| 密码哈希/验证                   | ❌           | 无                                               | 无正式注册系统                           |
| OAuth 登录                      | ❌           | 无                                               | 后期 Supabase                            |
| JWT/Session                     | ❌           | 无                                               | 同上                                    |
| ACL/RBAC                        | ❌           | 无                                               | 需 Postgres RLS                          |
| 防暴力/速率限制                 | ✅           | Cloudflare WAF                                   | —                                       |
| CSRF/XSS 防御                   | 🟡           | 基础 CSP + Astro sanitize                        | 需系统化测试                             |
| 一次性购买                      | ✅           | Stripe Payment Link                              | 已跑通                                  |
| 订阅套餐                        | ❌           | 无                                               | 需 Stripe Checkout+Tax                   |
| Checkout Session                | ❌           | 无                                               | 同上                                    |
| 退款/取消                       | ❌           | 无                                               | Webhook 未处理                           |
| 财务报表导出                    | ❌           | 无                                               | Stripe Sigma/API 二期                    |
| 对账通知                        | 🟡           | 成功页手动提醒                                   | 需邮件/站内信模板                        |
| 请求/异常日志                   | 🟡           | Sentry (前端) 已接；Workers 未全量               | Logflare 待接                            |
| 访问日志/审计                   | 🟡           | Cloudflare Analytics                             | 审计合规缺口                             |
| 指标仪表盘                      | 🟡           | 基础 CF Dashboard                                | Grafana 未部署                           |
| 告警阈值                        | ❌           | 无                                               | Slack/Email 待集成                       |
| 自动恢复脚本                    | ❌           | 手工备份                                         | Terraform restore 未完成                 |
| CI/CD (构建/测试)               | ✅           | GitHub Actions + Lint/Unit                       | E2E Playwright 跨浏览器缺                |
| 滚动发布/回滚                   | 🟡           | Cloudflare Pages 原子发布                        | 回滚脚本待补                             |

## 内容管理系统（CMS 同步层）逻辑链

### 1. Notion 同步服务

**详细逻辑链**

**输入**

- 定时触发：Cloudflare Worker `notion-proxy` 每 5 分钟触发调用。
- 手动触发：在 Wrangler 或 Dashboard 上手动部署/执行 `notion-proxy` Worker。
- 构建时触发：Astro 构建中调用 getCourses()。

**处理流程**

1. Worker 读取上次同步时间 `lastSync`（存储于 KV）。
2. 通过 `notion-proxy` Worker 发起请求：

   ```http
   GET https://<proxy-domain>/v1/databases/{DB_ID}/query
   Content-Type: application/json
   Notion-Version: 2022-06-28
   Authorization: Bearer ${NOTION_TOKEN}
   {
     "filter": {"property": "updated_time", "last_edited_time": {"after": "${lastSync}"}}
   }
   ```

3. 接收响应 JSON，推送原始数据到 KV：
   - 存储键：`notion:raw:<timestamp>`
   - 同步更新 `lastSync` 为最新 `updated_time`。
4. Worker 内部直接处理响应 JSON，执行字段映射、类型转换和清洗逻辑。
5. 构建时：在 `src/lib/notion.js` 中调用 `getCourses()`，获取最新课程元数据列表，写入 KV `notion:clean:build`。
6. 生成标准化 JSON 并写回 KV 或临时文件目录。

**输出**

- KV 中存储清洗前后差分数据。
- 更新 `lastSync` 键值。

**异常/边界处理**

- **notion-proxy Worker fetch 错误**：如 429 限流，指数退避重试 3 次。
- **网络/API 错误**：记录 Sentry 日志，Worker 状态码非 2xx 则抛警告。
- **Worker 逻辑异常**：捕获所有异常并写入日志，不中断后续流程。

#### 简化链条

`Scheduled Worker 轮询 → notion-proxy 转发 → Worker 清洗 → getCourses() 构建触发 → KV 更新 lastSync`

### 2. 内容存储

**详细逻辑链**

**输入**

- 清洗脚本输出的标准化 JSON（KV 或临时文件）

**处理流程**

1. 脚本或构建流程读取 KV 中标准化 JSON：键 `notion:clean:<id>`。
2. 将 JSON 中的课程元数据写入 Cloudflare D1 表 `course_metadata`：

   ```js
   await d1.prepare("INSERT OR REPLACE INTO course_metadata (id, title, slug, category, price, updated_at) VALUES (?, ?, ?, ?, ?, ?)")
            .bind([id, title, slug, category, price, updatedAt])
            .run();
   ```

3. 将多媒体资源（图片、音频、视频）URL 列表存入 KV：键 `course:media:<id>`。
4. 对每个资源 URL，同步到 R2 存储：

   ```bash
   curl -X PUT "https://<R2_BUCKET>.r2.cloudflarestorage.com/course/<id>/media/<filename>" \
        -H "Authorization: Bearer <TOKEN>" \
        --data-binary @<local-file>
   ```

5. 在 R2 上生成资源清单 JSON，写入 KV：键 `course:media_list:<id>`。

**输出**

- D1 表中保存课程元数据记录。
- KV 中保存媒体 URL 列表和资源清单。

**异常/边界处理**

- **D1 写入失败**：捕获异常，重试 2 次，失败后落 BLOB 存储到 KV `course:failed:<id>`。
- **R2 上传错误**：记录日志到 Sentry，跳过失败资源，后续脚本可补偿。
- **资源权限**：设置 R2 对象为公开读，确保前端可访问。

**简化链条**
``读取 KV JSON → 写入 D1 course_metadata → 同步媒体到 R2 → 更新 KV 媒体清单``

### 3. 内容发布接口

**详细逻辑链**

**输入**

- 构建时：R2 上的课程 JSON 清单。
- 运行时：前端页面请求的课程 `slug`。

**处理流程**

1. **构建时拉取**：在 Astro `getStaticPaths` 中，调用 Worker API `/api/metadata` 获取所有课程 `slug` 列表。
2. 在 `getStaticProps({ params })` 中，读取 R2 `course/{slug}/metadata.json` 并注入页面 props。
3. **运行时查询**：前端页面对 `/api/content/:slug` 发起 fetch。
4. Worker `/api/content/:slug`：首先从 KV `course:clean:<slug>` 获取 JSON，如未命中则从 R2 读取并写入 KV。
5. 返回 JSON 响应给前端，供动态渲染或交互调用。
6. **缓存与失效**：Worker 在返回后，设置 Cache-Control 头 `max-age=300`。

**输出**

- 构建时：静态生成的课程页面 HTML。
- 运行时：JSON 内容响应。

**异常/边界处理**

- **KV 未命中**：直接读取 R2，再回写 KV。
- **R2 读取失败**：返回 404; 记录 Sentry 错误。
- **过期缓存**：Worker 在 `Cache-Control` 过期后，自动重新请求 R2。

**简化链条**
``Static build: R2 JSON → Astro pages; Runtime: fetch API → KV/R2 → JSON``

## 前端 UI 系统逻辑链

### 1. 页面框架

**详细逻辑链**

**输入**

- 浏览器地址栏 URL 变化。
- `<a>` 或 Astro Link 点击事件。

**处理流程**

1. Astro 根据 `src/pages/` 文件系统路由匹配到目标页面组件。
2. 渲染 `src/layouts/Layout.astro`，构建基础 HTML 结构，并在 `<slot />` 处注入页面内容。
3. 页面模板加载相关 CSS 和静态资源；Hydrate Islands 组件，启动动态交互。
4. 客户端路由变化时，Astro Islands 实现局部更新，无全页刷新。

**输出**

- 初次加载：服务端生成的 HTML + CSS。
- 交互态：客户端 JS 渲染并管理动态部分。

**异常/边界处理**

- 路由未命中：Astro 自动响应 404 页面。
- 渲染错误：前端错误捕获并上报 Sentry，展示错误提示。

**简化链条**
``URL/点击 → 文件路由匹配 → Layout.astro 渲染 → 页面内容挂载 → Islands 客户端挂载``

### 2. 组件库

**详细逻辑链**

**输入**

- 页面或其他组件传入 Props。

**处理流程**

1. 原子组件（按钮、表单、卡片）接收 Props 并渲染基础结构与样式。
2. 复合组件（课程卡、用户面板、进度条）组合原子组件，实现复杂 UI 和交互逻辑。
3. 事件回调通过 Props 上抛，返回至父组件或页面。

**输出**

- 渲染完成的 UI 元素，支持可复用与一致性。

**异常/边界处理**

- Props 校验（TS 类型或 PropTypes），缺失值回落至默认值。

**简化链条**
``Props → 原子组件 → 复合组件 → 页面引用``

### 3. 状态管理

**详细逻辑链**

**输入**

- 用户操作事件（点击、输入、表单提交）。

**处理流程**

1. 本地状态：组件内部通过 `useState` 管理临时状态。
2. 全局状态：通过 React Context 提供和消费全局数据（如用户信息）。
3. 状态变化触发对应组件重新渲染，维持 UI 同步。

**输出**

- 组件渲染反映最新状态。

**异常/边界处理**

- 并发更新冲突：可使用 `useReducer` 或队列机制确保一致性。

**简化链条**
``事件 → 更新状态 → 组件重渲染``

### 4. 辅助功能

**详细逻辑链**

**输入**

- 国际化：用户或浏览器语言设置。
- 可访问性：无障碍需求。
- 响应式：设备宽度或媒体查询触发。

**处理流程**

1. 国际化：未来通过 i18n 插件加载对应 JSON 词条，通过 Hook 获取文本。
2. 可访问性：运行时或 CI 检查组件的 ARIA 属性和焦点顺序。
3. 响应式：Tailwind 类根据断点自动应用不同样式。

**输出**

- 多语言文本渲染、无障碍属性生效、样式适配不同设备。

**异常/边界处理**

- 文本缺失：回退到默认语言。
- 可访问性违规：CI 报警并阻止合并。

**简化链条**
``i18n加载 → a11y检查 → Tailwind响应式应用``

## 后端 API 系统逻辑链

### 1. 认证授权 API

**详细逻辑链**

**输入**

- 前端 POST `/api/auth/signup` 提交 `{ email, password }`。
- 前端 POST `/api/auth/signin` 提交 `{ email, password }`。
- 前端 POST `/api/auth/refresh` 提交 `{ refresh_token }`。

**处理流程**

1. **注册** (`/api/auth/signup`)：
   - 接收请求 Body，校验字段完整性。
   - 调用 `supabase.auth.signUp({ email, password })`。
   - 若成功，Supabase 返回 `user` 与 `session`，并发送确认邮件（可选）。
   - 将 `access_token` 和 `refresh_token` 返回给客户端。
2. **登录** (`/api/auth/signin`)：
   - 接收请求 Body，校验字段完整性。
   - 调用 `supabase.auth.signInWithPassword({ email, password })`。
   - 成功后返回 `session` 包含 `access_token` 和 `refresh_token`。
3. **刷新令牌** (`/api/auth/refresh`)：
   - 接收 `refresh_token`，校验其格式。
   - 调用 `supabase.auth.refreshSession({ refresh_token })`。
   - 返回新的 `access_token` 和 `refresh_token`。
4. **权限校验中间件**：
   - 对所有受保护 API 路由，读取 `Authorization` 头中的 Bearer Token。
   - 调用 `supabase.auth.getUser(token)` 验证合法性。
   - 检查用户角色（如 `user.role`），根据路由权限规则决定放行或拒绝。

**输出**

- 200 OK + `{ access_token, refresh_token, user }` 或 401/403 错误信息。

**异常/边界处理**

- **参数缺失**：返回 400 Bad Request。
- **Supabase 错误**：捕获并返回 4xx/5xx 错误码与信息。
- **Token 验证失败**：返回 401 Unauthorized。
- **权限不足**：返回 403 Forbidden。

**简化链条**

## 数据存储系统逻辑链

### 1. 主业务数据库（Supabase/Postgres 临时 D1）

**详细逻辑链**

**输入**

- API 调用：用户相关、课程管理、订单/订阅 CRUD 请求（来自 Admin API 或前端服务）。

**处理流程**

1. 读取环境绑定：`locals.env.LRS_DB`（Cloudflare D1）或在 Phase-1 切换至 Supabase Postgres 客户端。
2. **用户表（profiles）**
   - `GET /api/admin/users`：执行 SQL `SELECT * FROM profiles` 或 `supabase.from('profiles').select('*')`。
   - `POST /api/admin/users`：插入新用户：`INSERT INTO profiles (id, email, name, role, created_at) VALUES (?, ?, ?, ?, ?)`。
3. **课程结构表（courses, modules）**
   - `GET /api/admin/courses`：查询 `courses` 表及关联 `modules`：`SELECT c.*, m.* FROM courses c LEFT JOIN modules m ON m.course_id = c.id`。
   - `POST/PUT/DELETE`: 分别执行 INSERT/UPDATE/DELETE 操作。
4. **订单与订阅表（orders, subscriptions）**
   - `checkout.session.completed` Webhook 写入 `orders` 表：`INSERT INTO orders (id, user_id, course_id, amount, status, created_at) VALUES ...`。
   - 订阅管理（Phase-1）：使用 `supabase.from('subscriptions')` API 操作。

**输出**

- CRUD 操作返回受影响的行或查询结果数组。

**异常/边界处理**

- **字段校验失败**：返回 400 Bad Request。
- **D1 写入/查询错误**：记录 Sentry，返回 500 Internal Server Error。

**简化链条**
``请求 → D1/Postgres SQL → 返回 JSON``

### 2. 进度存储（Cloudflare D1）

**详细逻辑链**

**输入**

- xAPI 接口 (`POST /api/statement`) 写入语句。
- 进度汇总查询 (`GET /api/progress`).

**处理流程**

1. **xAPI 语句表（statements）**
   - 在 `POST /api/statement` 中，使用 `locals.env.LRS_DB.prepare(...).run()` 插入语句到 `statements` 表。
2. **进度汇总表（user_progress）**
   - 在 `GET /api/progress` 中，执行聚合查询：

     ```sql
     CREATE TABLE IF NOT EXISTS user_progress AS
       SELECT actor AS user_id, object AS course_id, COUNT(*) AS interactions
         FROM statements
        GROUP BY actor, object;
     ```

   - 或直接运行：`SELECT object AS courseId, COUNT(*) AS interactions FROM statements WHERE actor = ? GROUP BY object`。

**输出**

- `POST` 返回 `{ status: 'ok', id }`。
- `GET` 返回 `{ progress: [...] }`。

**异常/边界处理**

- **SQL 执行失败**：捕获错误并上报 Sentry，返回 500。

**简化链条**
``POST statement → D1 insert → 返回 ok``
``GET progress → D1 aggregate → 返回数据``

## 安全认证系统逻辑链

### 1. 用户认证

**详细逻辑链**

**输入**

- POST `/api/auth/signup` 接收 `{ email, password }`。
- POST `/api/auth/signin` 接收 `{ email, password }` 或第三方 OAuth 回调。

**处理流程**

1. **本地密码注册/登录**：
   - 接收请求 Body，校验格式与必填字段。
   - 调用 `supabase.auth.signUp` 或 `supabase.auth.signInWithPassword`。
   - Supabase 内部执行密码哈希与验证。
   - 若成功，生成会话并返回用户信息和 Token。
2. **第三方登录（OAuth）**：
   - 前端重定向到 Supabase OAuth 提供者。
   - OAuth 回调发送到 `/api/auth/callback`，调用 `supabase.auth.exchangeOAuthCode`。
   - 若成功，返回或创建用户记录。

**输出**

- 成功：200 OK + `{ user, session: { access_token, refresh_token } }`。
- 失败：4xx 错误 + `{ error }`。

**异常/边界处理**

- **参数缺失/格式错误**：400 Bad Request。
- **认证失败**：401 Unauthorized。
- **Supabase 错误**：返回原始错误码与信息。

**简化链条**
``前端 POST auth → supabase.auth → 返回 session/JWT``

### 2. 会话管理

**详细逻辑链**

**输入**

- 所有受保护请求带 `Authorization: Bearer <access_token>`。
- POST `/api/auth/refresh` 接收 `{ refresh_token }`。

**处理流程**

1. **JWT 验证**：
   - 中间件解析 `Authorization` 头，调用 `supabase.auth.getUser(access_token)`。
   - 验证签名和过期时间。
2. **刷新机制**：
   - 接收 `refresh_token`，调用 `supabase.auth.refreshSession`。
   - 返回新的 `access_token` 和 `refresh_token`。
3. **黑名单/注销**：
   - 若用户登出，前端调用 `/api/auth/logout`，中间件将 `access_token` 加入 KV 黑名单并使之失效。

**输出**

- 验证通过：继续执行下游处理。
- 刷新成功：返回新的 Token。
- 验证失败/已注销：401 Unauthorized。

**异常/边界处理**

- **Token 缺失**：401 Unauthorized。
- **刷新失败**：401，提示重新登录。

**简化链条**
``请求 → 验证 Token → 刷新 / 黑名单 → 放行/拒绝``

### 3. 访问控制（ACL/RBAC）

**详细逻辑链**

**输入**

- 受保护路由请求，包含 `user.role` 和 `user.id`。

**处理流程**

1. 在中间件中获取用户角色，例如 `admin`, `teacher`, `student`。
2. 根据路由策略映射权限，例如：
   - `/api/admin/*` 仅限 `admin`。
   - `/api/teacher/*` 允许 `teacher` 与 `admin`。
   - `/api/student/*` 允许所有已登录用户。
3. 拒绝无权限用户，记录尝试日志。

**输出**

- 有权限：继续执行。
- 权限不足：403 Forbidden。

**异常/边界处理**

- **角色缺失**：400 Bad Request。
- **内部错误**：500 Internal Server Error。

**简化链条**
``中间件读取角色 → 验证权限 → 放行/拒绝``

### 4. 安全防护

**详细逻辑链**

**输入**

- 所有 API 请求。

**处理流程**

1. **防暴力破解**：
   - 使用 Cloudflare WAF 或 Rate Limiting 在 `/api/auth/*` 限制每 IP 每分钟请求次数。
2. **CSRF 防御**：
   - 对重要操作（如 POST/PUT/DELETE）要求 `X-CSRF-Token` header，与 Cookie 绑定验证。
3. **XSS 防御**：
   - 使用 `Astro sanitize` 清理用户输入并设置 CSP headers (`default-src 'self'; script-src 'self'`).

**输出**

- 拦截恶意请求：429 或 403 错误。
- 合法请求：正常执行。

**异常/边界处理**

- **速率限制触发**：429 Too Many Requests。
- **CSRF 校验失败**：403 Forbidden。

**简化链条**
``WAF 速率限制 → CSRF 验证 → XSS sanitize → 正常/拦截``

### 3. 静态资源与大文件（R2）

**详细逻辑链**

**输入**

- 媒体文件上传请求：`scripts/uploadMedia.ts` 或同步 Worker 提供的上传 API。
- 构建时静态资源读取：Astro 构建阶段需访问 R2 文件列表。

**处理流程**

1. **上传**：
   - 脚本或 Worker 调用 `env.R2_COURSE.put(`
   - 键格式 `course/{id}/media/{filename}`，数据为 Blob 或 Buffer。
2. **版本化**：
   - 每次上传相同键时，R2 自动版本控制。
   - 可通过 R2 API 列出对象版本或回滚。
3. **过期策略**：
   - 在上传时设置对象元数据 `Cache-Control: max-age=86400, immutable`。
   - 定期通过 Worker 脚本或 Terraform 更新过期规则。

**输出**

- R2 存储多个版本的媒体文件。
- 对象可通过 URL `https://<account>.r2.cloudflarestorage.com/course/{id}/media/{filename}` 公网访问。

**异常/边界处理**

- **上传失败**：捕获错误并重试 2 次，失败后记录到 KV `r2:upload:failures`。
- **版本列表失败**：记录日志，返回 500。
- **访问权限**：确保默认公共读，或在 URL 加签名。

**简化链条**
``脚本/Worker 上传 → R2 存储 → 版本控制 → 可访问``

### 4. 缓存层（KV）

**详细逻辑链**

**输入**

- 读写热点数据请求，例如课程 JSON、用户会话数据。
- 清洗后的 Notion 数据由 Sync Worker 写入 KV。

**处理流程**

1. **写入**：
   - 在 Worker 中调用 `env.TIBETAN_KV.put(key, JSON.stringify(data), { expirationTtl: ttl })`。
2. **读取**：
   - Worker 或 API 路由使用 `env.TIBETAN_KV.get(key, 'json')` 读取数据。
3. **过期管理**：
   - `expirationTtl` 根据数据类型设置，例如媒体列表 TTL 3600，清洗数据 TTL 300。
   - 可通过双写策略在过期前刷新缓存。
4. **会话信息**：
   - 用户登录后将 JWT/会话信息存 KV：键 `session:{session_id}`。
   - 在中间件中读取会话校验权限。

**输出**

- KV 返回 JSON 数据供 Worker/API 使用。
- 缓存命中可降低 D1/R2 访问频率，提升性能。

**异常/边界处理**

- **KV 写入/读取失败**：记录错误，回退到读取原始存储层（D1/R2）。
- **缓存击穿**：当 KV 未命中时，同步拉取源头并回写 KV。

**简化链条**
``写入 KV → 读取 KV → 过期后源头回写``

### 2. 内容服务 API

**详细逻辑链**

**输入**

- GET `/api/courses`：前端请求课程列表。
- GET `/api/courses?category=<category>&search=<keyword>`：支持筛选与搜索。
- GET `/api/courses/:slug`：前端请求单个课程详情。

**处理流程**

1. **课程列表** (`/api/courses`)
   - 读取 D1 表 `course_metadata` 或 KV 中的清洗数据（优先 KV）。
   - 如存在查询参数，执行内存或 D1 层面的过滤。
   - 返回 JSON 数组：`[{ id, title, slug, category, price, updatedAt }, ...]`。
2. **课程详情** (`/api/courses/:slug`)
   - 从 KV `notion:clean:<slug>` 获取元数据；如未命中，回落 D1 查询并写入 KV。
   - 同步读取媒体清单 `course:media_list:<slug>`，拼装详情结构。
   - 返回完整课程对象：带 `media` 列表的 JSON。
3. **搜索/筛选**
   - 对于简单关键词，前端可使用 Fuse.js 或 Worker 在 KV 中执行全文匹配；
   - 对于复杂筛选，直接在 D1 使用 SQL `WHERE category = ? AND title LIKE ?`。

**输出**

- JSON 格式的课程列表或课程详情。

**异常/边界处理**

- **资源缺失**：课程不存在返回 404。
- **参数错误**：无效查询参数返回 400。
- **D1/KV 读取失败**：记录 Sentry 错误，返回 500。

**简化链条**
``GET courses/list → KV/D1 → 过滤 → 返回 JSON``
``GET course/detail → KV/R2 → 拼装 → 返回 JSON``

### 3. 学习进度 API

**详细逻辑链**

**输入**

- POST `/api/statement`：前端提交 xAPI 语句 JSON。
- GET `/api/progress?actor=<actor>&session_id=<session_id>`：查询某用户学习进度。

**处理流程**

1. **xAPI 接口** (`POST /api/statement`)
   - 接收 JSON Body 并校验 `actor`、`verb`、`object` 字段。
   - 在开发环境（import.meta.env.DEV）使用 mock DB；生产环境使用 `locals.env.LRS_DB`（Cloudflare D1）。
   - 生成 UUID 和 timestamp，执行 SQL `INSERT INTO statements (...) VALUES (...)`。
   - 返回 `{ status: 'ok', id }`。
2. **进度汇总查询** (`GET /api/progress`)
   - 接收查询参数 `actor` 和/或 `session_id`。
   - 构造 SQL 查询：

     ```sql
     SELECT object AS courseId, COUNT(*) AS interactions
       FROM statements
      WHERE actor = ?
        AND (session_id = ? OR ? IS NULL)
      GROUP BY object;
     ```

   - 执行查询并返回 `{ progress: [{ courseId, interactions }, ...] }`。

**输出**

- `POST /api/statement`：201 Created + `{ status: 'ok', id }`。
- `GET /api/progress`：200 OK + `{ progress: [...] }`。

**异常/边界处理**

- **字段校验失败**：返回 400 Bad Request。
- **DB 操作异常**：记录 Sentry 日志，返回 500 Internal Server Error。

**简化链条**
``POST statement → D1 insert → 返回 ok``
``GET progress → D1 aggregate → 返回进度数据``

### 4. 支付回调 API

**详细逻辑链**

**输入**

- Stripe Webhook 请求推送到 `/api/webhook`（Cloudflare Worker）。

**处理流程**

1. 接收请求，提取 `Stripe-Signature` 头。
2. 使用 Stripe SDK 验证签名：

   ```js
   const event = stripe.webhooks.constructEvent(rawBody, sig, endpointSecret);
   ```

3. 根据 `event.type` 分支处理：
   - `checkout.session.completed`：
     - 从 `event.data.object` 获取 `session_id`、`customer_email`、`amount_total` 等；
     - 写入 D1 表 `orders` 或 Supabase `subscriptions`：标记订单已支付；
   - `charge.refunded`：
     - 写入 D1 表 `refunds`：记录退款事件；
   - 其他事件：可选记录日志或忽略。
4. 返回 200 响应给 Stripe，确认接收。

**输出**

- HTTP 200 OK 确认。
- 在数据库中生成或更新订单/退款记录。

**异常/边界处理**

- **签名验证失败**：返回 400 Bad Request，不触发后续逻辑。
- **数据库写入错误**：捕获异常，记录 Sentry，返回 500 Internal Server Error。

**简化链条**

```
Stripe Webhook → 验签 → 分支处理 → DB 更新 → 返回 200
```

### 5. 管理后台 API

**详细逻辑链**

**输入**

- 前端或 Admin UI 对受保护路由如 `/api/admin/courses`、`/api/admin/users` 的 CRUD 请求。
- 请求携带 `Authorization: Bearer <token>`。

**处理流程**

1. **权限校验中间件**：验证 Token 并检查 `user.role === 'admin'`。
2. **内容 CRUD** (`GET/POST/PUT/DELETE /api/admin/courses`)
   - `GET`：查询 Supabase 或 D1 `course_metadata`。
   - `POST`：接收课程数据，写入 `course_metadata` 并上传媒体至 R2。
   - `PUT`：更新课程元数据及媒体索引。
   - `DELETE`：删除 D1 记录与 R2 资源。
3. **用户与权限管理** (`GET/POST /api/admin/users`)
   - 管理用户列表、角色分配，通过 Supabase Admin API。
4. **报表与统计接口** (`GET /api/admin/reports`)
   - 聚合 D1 或 Supabase 数据，计算注册、支付、学习进度等统计；
   - 返回 BI 所需的 JSON 数据。

**输出**

- JSON 响应：CRUD 结果或报表数据。

**异常/边界处理**

- **未授权访问**：返回 401 Unauthorized。
- **权限不足**：返回 403 Forbidden。
- **参数校验失败**：返回 400 Bad Request。
- **内部错误**：记录 Sentry，返回 500 Internal Server Error。

**简化链条**

```
AuthMiddleware → CRUD/Report Handler → DB 操作 → 返回 JSON
```

## 支付变现系统逻辑链

### 1. 订单创建

**详细逻辑链**

**输入**

- 用户在前端点击“购买”或“订阅”按钮。
- 发送 POST `/api/create-order` 请求，携带 `{ productId, type: 'one_time'|'subscription' }`。

**处理流程**

1. 验证请求参数（`productId`、`type`）。
2. 根据 `type` 分支：
   - **一次性购买**：
     - 读取本地配置中对应的 Stripe Payment Link URL。
     - 创建内部订单记录至 D1 `orders` 表，状态 `pending`。
   - **周期性订阅**：
     - 读取预配置的 Stripe Subscription Price ID。
     - 同样创建订单或订阅记录至 D1 `subscriptions` 表，状态 `pending`。
3. 返回 `{ orderId, paymentLink }` 给前端。

**输出**

- 200 OK + `{ orderId, paymentLink }`。

**异常/边界处理**

- 参数校验失败：400 Bad Request。
- D1 写入失败：记录 Sentry 错误，返回 500 Internal Server Error。

**简化链条**
``前端 POST create-order → D1 写入 pending → 返回 paymentLink``

### 2. 支付流程

**详细逻辑链**

**输入**

- 前端收到 `paymentLink` 后，使用 `window.location.href = paymentLink` 重定向。

**处理流程**

1. 浏览器跳转至 Stripe Payment Link 页面。
2. 用户完成支付或取消。
3. Stripe 将用户重定向到预设的 `success_url` 或 `cancel_url`。
   - `success_url` 包含 `session_id` 查询参数；
   - 前端通过 `/success?session_id=` 检查支付结果。

**输出**

- 成功：前端展示支付成功页面。
- 取消：展示支付取消或 retry 页面。

**异常/边界处理**

- 无效链接：前端校验 `paymentLink` 有效性，否则返回 400。

**简化链条**
``重定向 → Stripe Checkout → success/cancel → 前端处理``

### 3. Webhook 处理

**详细逻辑链**

**输入**

- Stripe Webhook 在 `/api/webhook` 推送事件：`checkout.session.completed`, `invoice.payment_failed`, `charge.refunded` 等。

**处理流程**

1. 验证签名并解析事件。
2. **支付成功** (`checkout.session.completed`)：
   - 从 `event.data.object` 提取 `session_id`、`customer_email`、`amount_total`。
   - 更新 D1 `orders` 表中对应 `orderId` 的状态为 `paid`，写入支付时间。
3. **支付失败** (`invoice.payment_failed`)：
   - 更新订单/订阅记录状态为 `failed`，可发送提醒。
4. **退款或取消** (`charge.refunded`)：
   - 在 D1 `refunds` 表插入退款记录，更新 `orders` 或 `subscriptions` 状态为 `refunded`。
5. 返回 200 响应给 Stripe。

**输出**

- HTTP 200 OK，Stripe 停止重试。

**异常/边界处理**

- 签名验证失败：返回 400，日志记录。
- D1 写入异常：记录 Sentry，返回 500。

**简化链条**
``Webhook → 验签 → 分支更新 D1 → 返回 200``

### 4. 对账与通知

**详细逻辑链**

**输入**

- 定时任务或手动触发的对账请求（如每日对接任务）。

**处理流程**

1. 调用 Stripe API 获取过去时间段内的支付、退款事件清单。
2. 与本地 D1 `orders`/`subscriptions` 数据对比，找出差异。
3. 将差异结果生成报表 JSON，存储至 KV `reports:finance:<date>`。
4. 通过 Email 服务或站内信接口，将报表链接或摘要发送给财务人员。

**输出**

- 报表 JSON 存 KV。
- 财务通知邮件/站内信。

**异常/边界处理**

- Stripe API 调用失败：记录 Sentry 日志，重试或报警。
- 通知发送失败：记录队列重试。

**简化链条**
``Stripe API 拉取 → 对比 D1 → 存 KV 报表 → 发送通知``

# 📊 xAPI 数据链路总览（写入 + 查询）

## ✅ 数据写入链路（POST）

```text
[前端页面或脚本]
       │
       ▼
submitXAPIStatement(statement: XAPIStatement)  
       ← src/lib/api/xapi.client.ts
       │
       ▼
POST /api/statement.ts  
       ← src/pages/api/statement.ts
       │
   [校验 JSON 请求体格式（actor / verb / object）]
       │
   [生成 UUID + timestamp]
       │
   [调用 env.LRS_DB.prepare(...).run()] 
       ⟶ 插入 D1 数据库：tibetan-lrs-db.statements 表
       │
       ▼
响应：{ status: "ok", id: "<uuid>" }
```

---

### 🔍 数据查询链路（GET）

```text
[前端页面或脚本]
       │
       ▼
fetchXAPIStatements({actor?, session_id?})  
     ← src/lib/api/xapi.client.ts
       │
       ▼
GET /api/statement.ts?actor=...&session_id=...
       ← src/pages/api/statement.ts
       │
   [拼接查询参数 → SQL WHERE 子句]
       │
   [调用 env.LRS_DB.prepare(...).all()]  
       ⟶ 查询 D1 数据库：tibetan-lrs-db.statements 表
       │
       ▼
响应：{ statements: [...] }
```

---

## 📁 文件结构与职责说明

| 文件路径 | 作用描述 | 说明 |
|----------|----------|------|
| `src/pages/api/statement.ts` | 🌐 **API 接口主入口**：统一处理 xAPI 写入与查询 | 是整个系统的服务入口，直接连接数据库，不依赖任何外部路由机制（如 Hono） |
| `src/lib/api/xapi.client.ts` | 🧠 前端调用桥 | 封装前端请求 `/api/statement` 接口的提交和查询函数，供 React/Vue/模板等 UI 组件调用 |
| `src/types/env.d.ts` | 🔧 声明环境绑定 | 指定 `LRS_DB: D1Database` 绑定名称，确保 Cloudflare Workers 可访问数据库 |
| `migrations/001_init.sql` | 🧱 数据结构迁移脚本 | 创建 `statements` 表，包含字段定义和约束 |
| `wrangler.toml` | ⚙️ Cloudflare 配置文件 | 声明 D1 数据库绑定（LRS_DB）、KV、R2 等，明确绑定 ID 与名称 |
| （未来推荐）`docs/xapi-schema.md` | 📚 Schema 结构说明 | 推荐写清 actor/verb/object/result 的结构约定，提升规范性与可维护性 |

---

## 🧮 `statements` 表结构（D1 数据库）

```sql
CREATE TABLE IF NOT EXISTS statements (
  id TEXT PRIMARY KEY,              -- 自动生成的 UUID
  actor TEXT NOT NULL,              -- 必填：学习者标识（邮箱/ID）
  verb TEXT NOT NULL,               -- 必填：行为（viewed/completed 等）
  object TEXT NOT NULL,             -- 必填：学习对象（页面/课程等 ID）
  result JSON,                      -- 可选：学习结果，任意 JSON 结构
  timestamp TEXT NOT NULL,          -- 自动生成时间戳
  session_id TEXT                   -- 可选：学习会话 ID
);
```

---

## 📦 前端调用方式

### 1. 提交语句（写入）

```ts
import { submitXAPIStatement } from '@/lib/api/xapi.client';

await submitXAPIStatement({
  actor: 'user@example.com',
  verb: 'viewed',
  object: 'course:lesson-1',
  result: { score: 95 },
  session_id: 'abc-session-xyz',
});
```

返回值：

```ts
{
  status: "ok",
  id: "6f782d53-fabd-44d7-8a2e-35d9b1e0b2de"
}
```

---

### 2. 查询语句（按 actor/session_id）

```ts
import { fetchXAPIStatements } from '@/lib/api/xapi.client';

const result = await fetchXAPIStatements({ actor: 'user@example.com' });

console.log(result.statements); // 返回语句数组
```

---

## ✅ 总结

- ✅ 所有数据写入与查询，**均通过 `/api/statement.ts` 实现**
- ✅ 当前系统无任何 Hono 路由或其他多余入口，**数据链路清晰、单一、可维护**
- ✅ D1 数据库结构合理，支持后期扩展 session/模块/用户等维度
- ✅ 前端只需调用 `xapi.client.ts` 提供的函数，无需关心底层 API 细节

---
